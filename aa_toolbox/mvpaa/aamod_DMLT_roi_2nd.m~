% AA module - MVPaa 2nd level
%
% Modified for aa4 by Alejandro Vicente-Grabovetsky Feb-2011

function [aap,resp] = aamod_DMLT_roi_2nd(aap,task)

resp='';

switch task
    case 'doit'
        
        for p = 1:length(aap.acq_details.subjects)
            load(aas_getfiles_bystream(aap,p,'DMLT'));
            
            keyboard
            if p == 1
                % MVPA data for Multivariate results
                indStats = nan(length(aap.acq_details.subjects), ... % Subj
                    size(DMLout,1), ... % ROIs
                    size(DMLout,2)); % Contrasts
                
                Stats = nan( ... % Subj
                    size(DMLout,1), ... % ROIs
                    size(DMLout,2)); % Contrasts
            end
            
            for r = 1:size(DMLout,1)
                for c = 1:size(DMLout,2)
                    % Gather data from each participant
                    indStats(p, r, c) = DMLout{r,c}.accuracy;
                end
            end
        end
        
        % 2nd level stats (aggregate StatisticollStat -> collapsed Statistics)
        for r = 1:size(DMLout,1)
            for c = 1:size(DMLout,2)
                [h Stats(r,c)] = ttest(indStats(:, r, c));
            end
        end
        
        
        keyboard
        
        %% Describe outputs...
        save(fullfile(aap.acq_details.root, 'DMLT.mat'), ...
                '@@@')
        aap=aas_desc_outputs(aap,'DMLT_2nd', fullfile(aap.acq_details.root, 'DMLT.mat'));
end